<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>競馬指数ビューア</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; color: #333; font-size: 14px; }

.header { background: #1a5c2a; color: #fff; padding: 12px 16px; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 16px; }

.filters { padding: 8px 16px; background: #fff; border-bottom: 1px solid #ddd; }
.filter-row { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
.filter-row:last-child { margin-bottom: 0; }
.filter-row input, .filter-row select {
  padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
  background: #fff;
}
.filter-row input { flex: 1; min-width: 0; }
.filter-row select { flex: 0 0 auto; }
#horse-search { flex: 1; }
#idx-min { width: 70px; flex: 0 0 70px; }

.stats { padding: 6px 16px; background: #e8f5e9; font-size: 12px; color: #555; }

.race-list { padding: 8px; }

.race-card {
  background: #fff; border-radius: 8px; margin-bottom: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;
}
.race-header {
  padding: 10px 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
}
.race-header:active { background: #f0f0f0; }
.race-title { font-weight: 600; font-size: 13px; }
.race-meta { font-size: 11px; color: #777; margin-top: 2px; }
.race-arrow { font-size: 12px; color: #999; transition: transform 0.2s; }
.race-card.open .race-arrow { transform: rotate(90deg); }

.race-body { display: none; border-top: 1px solid #eee; }
.race-card.open .race-body { display: block; }

.horse-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.horse-table th {
  background: #f8f8f8; padding: 4px 6px; text-align: center;
  font-weight: 600; border-bottom: 1px solid #ddd; white-space: nowrap;
  position: sticky; top: 0;
}
.horse-table td { padding: 4px 6px; border-bottom: 1px solid #f0f0f0; text-align: center; white-space: nowrap; }
.horse-table tr:nth-child(even) { background: #fafafa; }
.horse-table .name { text-align: left; font-weight: 500; }
.horse-table .idx { font-weight: 700; }
.idx-high { color: #c62828; }
.idx-mid { color: #e65100; }
.idx-low { color: #333; }
.highlight { background: #fff9c4 !important; }

.table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }

.loading { text-align: center; padding: 40px; color: #999; }
.no-results { text-align: center; padding: 40px; color: #999; }

.more-btn {
  display: block; width: 100%; padding: 12px; text-align: center;
  background: #fff; border: 1px solid #ddd; border-radius: 8px;
  font-size: 14px; color: #1a5c2a; cursor: pointer; margin-bottom: 8px;
}
.more-btn:active { background: #f0f0f0; }

.horse-link { color: #1a5c2a; text-decoration: underline; cursor: pointer; }
.horse-link:active { color: #0d3015; }

/* 馬詳細パネル */
.horse-detail { display: none; }
.horse-detail.active { display: block; }
.horse-detail-header {
  padding: 10px 16px; background: #fff; border-bottom: 1px solid #ddd;
  display: flex; align-items: center; gap: 12px;
}
.back-btn {
  padding: 6px 12px; background: #1a5c2a; color: #fff; border: none;
  border-radius: 4px; font-size: 13px; cursor: pointer; white-space: nowrap;
}
.back-btn:active { background: #0d3015; }
.horse-detail-name { font-size: 16px; font-weight: 700; }
.horse-detail-stats { font-size: 12px; color: #555; }
.horse-detail-body { padding: 8px; }
.detail-race-row {
  background: #fff; border-radius: 6px; margin-bottom: 6px; padding: 8px 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.08); font-size: 12px;
}
.detail-race-info { display: flex; justify-content: space-between; margin-bottom: 4px; }
.detail-race-label { font-weight: 600; font-size: 13px; }
.detail-race-date { color: #777; font-size: 11px; }
.detail-race-nums { display: flex; gap: 12px; flex-wrap: wrap; }
.detail-race-nums span { display: inline-block; }
.detail-race-nums .label { color: #777; }
</style>
</head>
<body>

<div class="header">
  <h1>競馬指数ビューア</h1>
</div>

<!-- メイン画面 -->
<div id="main-view">
  <div class="filters">
    <div class="filter-row">
      <input type="text" id="horse-search" placeholder="馬名で検索">
      <input type="number" id="idx-min" placeholder="指数≥">
    </div>
    <div class="filter-row">
      <input type="date" id="date-filter" style="flex:0 0 auto;">
      <select id="venue-filter"><option value="">競馬場</option></select>
      <select id="dist-filter"><option value="">距離</option></select>
      <select id="class-filter"><option value="">クラス</option></select>
      <select id="year-filter"><option value="">年</option></select>
    </div>
  </div>

  <div class="stats" id="stats"></div>
  <div class="race-list" id="race-list">
    <div class="loading" id="loading">年を選択してください</div>
  </div>
</div>

<!-- 馬詳細画面 -->
<div id="horse-detail" class="horse-detail">
  <div class="horse-detail-header">
    <button class="back-btn" onclick="closeHorseDetail()">&#9664; 戻る</button>
    <div>
      <div class="horse-detail-name" id="detail-name"></div>
      <div class="horse-detail-stats" id="detail-stats"></div>
    </div>
  </div>
  <div class="horse-detail-body" id="detail-body">
    <div class="loading">読み込み中...</div>
  </div>
</div>

<script>
const R = { ID:0, YEAR:1, VENUE:2, KAISAI:3, DAY:4, CLASS:5, SURFACE:6, DIST:7, WEATHER:8, COND:9, HORSES:10, DATE:11, RACENUM:12, BABA_SPEED:13 };
const H = { RANK:0, GATE:1, NUM:2, NAME:3, AGE:4, WEIGHT:5, JOCKEY:6, TIME:7, MARGIN:8, PASSING:9, LAST3F:10, POP:11, ODDS:12, TOTAL:13, LAST3F_IDX:14, ABILITY:15 };

let allRaces = [];
let filtered = [];
const PAGE_SIZE = 30;
let showCount = PAGE_SIZE;
const yearCache = {};
let metaData = [];
let currentYear = '';

function idxClass(v) {
  const n = parseInt(v);
  if (isNaN(n)) return 'idx-low';
  if (n >= 320) return 'idx-high';
  if (n >= 300) return 'idx-mid';
  return 'idx-low';
}

function buildSubFilters() {
  const venueEl = document.getElementById('venue-filter');
  const distEl = document.getElementById('dist-filter');
  const classEl = document.getElementById('class-filter');

  const curVenue = venueEl.value;
  const curDist = distEl.value;
  const curClass = classEl.value;

  venueEl.innerHTML = '<option value="">競馬場</option>';
  distEl.innerHTML = '<option value="">距離</option>';
  classEl.innerHTML = '<option value="">クラス</option>';

  const venues = [...new Set(allRaces.map(r => r[R.VENUE]))].sort();
  const dists = [...new Set(allRaces.map(r => r[R.DIST]))].sort((a,b) => a - b);
  const classes = [...new Set(allRaces.map(r => r[R.CLASS]))].sort();

  venues.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; venueEl.appendChild(o); });
  dists.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v + 'm'; distEl.appendChild(o); });
  classes.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; classEl.appendChild(o); });

  venueEl.value = curVenue;
  distEl.value = curDist;
  classEl.value = curClass;
}

async function loadYear(year) {
  if (yearCache[year]) return yearCache[year];
  const res = await fetch(`data_${year}.json`);
  const data = await res.json();
  yearCache[year] = data;
  return data;
}

async function loadAllYears() {
  const promises = metaData.map(m => loadYear(m.year));
  await Promise.all(promises);
}

async function onYearChange() {
  const year = document.getElementById('year-filter').value;
  const list = document.getElementById('race-list');
  const statsEl = document.getElementById('stats');

  if (!year) {
    allRaces = [];
    filtered = [];
    statsEl.textContent = '';
    list.innerHTML = '<div class="loading">年を選択してください</div>';
    return;
  }

  if (year === currentYear) {
    applyFilters();
    return;
  }

  currentYear = year;
  list.innerHTML = '<div class="loading">読み込み中...</div>';
  statsEl.textContent = '';

  try {
    allRaces = await loadYear(year);
    buildSubFilters();
    applyFilters();
  } catch (e) {
    list.innerHTML = '<div class="loading">読み込みエラー: ' + e.message + '</div>';
  }
}

function applyFilters() {
  const horseName = document.getElementById('horse-search').value.trim();
  const idxMin = parseInt(document.getElementById('idx-min').value) || 0;
  const venue = document.getElementById('venue-filter').value;
  const dist = document.getElementById('dist-filter').value;
  const cls = document.getElementById('class-filter').value;
  const dateVal = document.getElementById('date-filter').value; // "YYYY-MM-DD"
  const dateStr = dateVal ? dateVal.replace(/-/g, '') : ''; // → "YYYYMMDD"

  filtered = allRaces.filter(race => {
    if (dateStr && race[R.DATE] !== dateStr) return false;
    if (venue && race[R.VENUE] !== venue) return false;
    if (dist && race[R.DIST] !== dist) return false;
    if (cls && race[R.CLASS] !== cls) return false;

    if (horseName || idxMin) {
      const match = race[R.HORSES].some(h => {
        const nameMatch = !horseName || h[H.NAME].includes(horseName);
        const idxMatch = !idxMin || (parseInt(h[H.ABILITY]) >= idxMin);
        return nameMatch && idxMatch;
      });
      if (!match) return false;
    }
    return true;
  });

  showCount = PAGE_SIZE;
  render(horseName, idxMin);
}

async function onDateChange() {
  const dateVal = document.getElementById('date-filter').value;
  if (!dateVal) { applyFilters(); return; }
  const year = dateVal.substring(0, 4);
  const yearEl = document.getElementById('year-filter');
  if (yearEl.value !== year) {
    yearEl.value = year;
    await onYearChange();
  } else {
    applyFilters();
  }
}

function render(horseName, idxMin) {
  const list = document.getElementById('race-list');
  const statsEl = document.getElementById('stats');
  statsEl.textContent = `${filtered.length}レース該当`;

  if (filtered.length === 0) {
    list.innerHTML = '<div class="no-results">該当なし</div>';
    return;
  }

  const visible = filtered.slice(0, showCount);
  let html = '';

  for (const race of visible) {
    const id = race[R.ID];
    html += `<div class="race-card" id="race-${id}">`;
    html += `<div class="race-header" onclick="toggle('${id}')">`;
    html += `<div><div class="race-title">${race[R.VENUE]} ${race[R.DIST]}m ${race[R.CLASS]}</div>`;
    const d = race[R.DATE];
    const dateDisp = d ? `${d.substring(0,4)}/${d.substring(4,6)}/${d.substring(6,8)}` : `${race[R.YEAR]}年`;
    const rNum = race[R.RACENUM] ? `${race[R.RACENUM]}R` : '';
    const bSpeed = race[R.BABA_SPEED] || '';
    html += `<div class="race-meta">${dateDisp} ${rNum} ${race[R.COND]}${bSpeed ? '/' + bSpeed : ''} ${race[R.WEATHER]}</div></div>`;
    html += `<span class="race-arrow">&#9654;</span></div>`;

    html += `<div class="race-body"><div class="table-wrap"><table class="horse-table">`;
    html += `<tr><th>着</th><th>枠</th><th>番</th><th>馬名</th><th>斤量</th><th>騎手</th><th>タイム</th><th>上り</th><th>通過</th><th>総合</th><th>上り指</th><th>能力</th></tr>`;

    for (const h of race[R.HORSES]) {
      const isHighlight = (horseName && h[H.NAME].includes(horseName)) ||
                          (idxMin && parseInt(h[H.ABILITY]) >= idxMin);
      const hlClass = isHighlight ? ' highlight' : '';
      const escapedName = h[H.NAME].replace(/'/g, "\\'");
      html += `<tr class="${hlClass}">`;
      html += `<td>${h[H.RANK]}</td>`;
      html += `<td>${h[H.GATE]}</td>`;
      html += `<td>${h[H.NUM]}</td>`;
      html += `<td class="name"><span class="horse-link" onclick="showHorseDetail('${escapedName}')">${h[H.NAME]}</span></td>`;
      html += `<td>${h[H.WEIGHT]}</td>`;
      html += `<td>${h[H.JOCKEY]}</td>`;
      html += `<td>${h[H.TIME]}</td>`;
      html += `<td>${h[H.LAST3F]}</td>`;
      html += `<td>${h[H.PASSING]}</td>`;
      html += `<td class="idx ${idxClass(h[H.TOTAL])}">${h[H.TOTAL]}</td>`;
      html += `<td class="idx">${h[H.LAST3F_IDX]}</td>`;
      html += `<td class="idx ${idxClass(h[H.ABILITY])}">${h[H.ABILITY]}</td>`;
      html += `</tr>`;
    }

    html += `</table></div></div></div>`;
  }

  if (showCount < filtered.length) {
    html += `<button class="more-btn" onclick="loadMore()">もっと表示 (残り${filtered.length - showCount}件)</button>`;
  }

  list.innerHTML = html;
}

function toggle(id) {
  document.getElementById('race-' + id).classList.toggle('open');
}

function loadMore() {
  showCount += PAGE_SIZE;
  const horseName = document.getElementById('horse-search').value.trim();
  const idxMin = parseInt(document.getElementById('idx-min').value) || 0;
  render(horseName, idxMin);
}

// === 馬詳細画面 ===

async function showHorseDetail(name) {
  const mainView = document.getElementById('main-view');
  const detailView = document.getElementById('horse-detail');
  const detailBody = document.getElementById('detail-body');
  const detailName = document.getElementById('detail-name');
  const detailStats = document.getElementById('detail-stats');

  mainView.style.display = 'none';
  detailView.classList.add('active');
  detailName.textContent = name;
  detailStats.textContent = '読み込み中...';
  detailBody.innerHTML = '<div class="loading">全年データを読み込み中...</div>';

  // URL更新（ブラウザ履歴対応）
  history.pushState({ horse: name }, '', '?horse=' + encodeURIComponent(name));

  // 全年データを読み込み
  await loadAllYears();

  // 全年から該当馬のレースを抽出
  const results = [];
  for (const m of metaData) {
    const races = yearCache[m.year] || [];
    for (const race of races) {
      for (const h of race[R.HORSES]) {
        if (h[H.NAME] === name) {
          results.push({ race, horse: h });
          break;
        }
      }
    }
  }

  // レースID降順（新しい順）
  results.sort((a, b) => b.race[R.ID].localeCompare(a.race[R.ID]));

  if (results.length === 0) {
    detailStats.textContent = '該当レースなし';
    detailBody.innerHTML = '<div class="no-results">データが見つかりません</div>';
    return;
  }

  // 統計
  const abilities = results.map(r => parseInt(r.horse[H.ABILITY])).filter(v => !isNaN(v));
  const maxAbility = abilities.length ? Math.max(...abilities) : '-';
  const avgAbility = abilities.length ? (abilities.reduce((a,b) => a + b, 0) / abilities.length).toFixed(1) : '-';
  const wins = results.filter(r => r.horse[H.RANK] === '1' || r.horse[H.RANK] === 1).length;
  detailStats.textContent = `${results.length}戦${wins}勝 / 能力指数 最高${maxAbility} 平均${avgAbility}`;

  // レース一覧
  let html = '<div class="table-wrap"><table class="horse-table">';
  html += '<tr><th>日付</th><th>場</th><th>距離</th><th>クラス</th><th>馬場</th><th>斤量</th><th>着</th><th>タイム</th><th>上り</th><th>通過</th><th>総合</th><th>上指</th><th>能力</th></tr>';

  for (const { race, horse } of results) {
    html += '<tr>';
    const dd = race[R.DATE];
    const dateStr = dd ? `${dd.substring(0,4)}/${dd.substring(4,6)}/${dd.substring(6,8)}` : `${race[R.YEAR]}`;
    html += `<td>${dateStr}</td>`;
    html += `<td>${race[R.VENUE]}</td>`;
    html += `<td>${race[R.DIST]}m</td>`;
    html += `<td style="text-align:left;font-size:11px;max-width:100px;overflow:hidden;text-overflow:ellipsis">${race[R.CLASS]}</td>`;
    html += `<td>${race[R.COND]}</td>`;
    html += `<td>${horse[H.WEIGHT]}</td>`;
    html += `<td>${horse[H.RANK]}</td>`;
    html += `<td>${horse[H.TIME]}</td>`;
    html += `<td>${horse[H.LAST3F]}</td>`;
    html += `<td>${horse[H.PASSING]}</td>`;
    html += `<td class="idx ${idxClass(horse[H.TOTAL])}">${horse[H.TOTAL]}</td>`;
    html += `<td class="idx">${horse[H.LAST3F_IDX]}</td>`;
    html += `<td class="idx ${idxClass(horse[H.ABILITY])}">${horse[H.ABILITY]}</td>`;
    html += '</tr>';
  }

  html += '</table></div>';
  detailBody.innerHTML = html;
  window.scrollTo(0, 0);
}

function closeHorseDetail() {
  document.getElementById('horse-detail').classList.remove('active');
  document.getElementById('main-view').style.display = '';
  history.pushState({}, '', location.pathname);
}

// ブラウザ戻るボタン対応
window.addEventListener('popstate', (e) => {
  if (e.state && e.state.horse) {
    showHorseDetail(e.state.horse);
  } else {
    document.getElementById('horse-detail').classList.remove('active');
    document.getElementById('main-view').style.display = '';
  }
});

// 初期化
let debounceTimer;
function onFilterChange() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(applyFilters, 300);
}

document.getElementById('horse-search').addEventListener('input', onFilterChange);
document.getElementById('idx-min').addEventListener('input', onFilterChange);
document.getElementById('venue-filter').addEventListener('change', applyFilters);
document.getElementById('dist-filter').addEventListener('change', applyFilters);
document.getElementById('class-filter').addEventListener('change', applyFilters);
document.getElementById('year-filter').addEventListener('change', onYearChange);
document.getElementById('date-filter').addEventListener('change', onDateChange);

// meta.jsonから年リストを読み込み → URLパラメータ処理
fetch('meta.json')
  .then(r => r.json())
  .then(meta => {
    metaData = meta;
    const yearEl = document.getElementById('year-filter');
    for (const m of meta) {
      const o = document.createElement('option');
      o.value = m.year;
      o.textContent = m.year + '年 (' + m.count + ')';
      yearEl.appendChild(o);
    }

    // URLパラメータ ?horse=XXX で馬詳細を直接開く
    const params = new URLSearchParams(location.search);
    const horseName = params.get('horse');
    if (horseName) {
      showHorseDetail(horseName);
    }
  })
  .catch(e => {
    document.getElementById('loading').textContent = '読み込みエラー: ' + e.message;
  });
</script>
</body>
</html>
