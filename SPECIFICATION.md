# 競馬指数計算システム 仕様書

## 処理パイプライン

```
[scraper.js] + [runner.js]    スクレイピング
       |
  race_result/*.csv
       |
[build_base_times.js]          基準タイム生成
       |
  base_times.json
       |
[build_baba_diff.js]           馬場差算出
       |
  baba_diff.json
       |
[calc_index.js]                指数算出
       |
  race_index/*.csv
       |
[build_viewer_data.js]         ビューアデータ生成
       |
  docs/data_YYYY.json + meta.json
```

---

## 1. scraper.js — レース結果スクレイピング

### 概要
db.netkeiba.com からレース結果を取得し、CSVに出力する。

### 入出力
- **入力**: `https://db.netkeiba.com/race/{raceId}/` (EUC-JP)
- **出力**: `./race_result/result_{raceId}.csv`

### 取得データ
- レース情報: 競馬場名, 開催, 開催日, クラス, 芝/ダート, 距離, 天候, 馬場
- 馬情報: 着順, 枠番, 馬番, 馬名, 性齢, 斤量, 騎手, タイム, 着差, 通過, 上がり, 人気, 単勝オッズ

### 使い方
```bash
node scraper.js 202305040911
```

---

## 2. runner.js — スクレイピングループ実行

### 概要
指定した年・競馬場の全レースを順次スクレイピングする。

### 定数
- `DELAY_MS = 2000` — リクエスト間隔（2秒）

### 競馬場コード
| コード | 競馬場 | コード | 競馬場 |
|--------|--------|--------|--------|
| 01 | 札幌 | 06 | 中山 |
| 02 | 函館 | 07 | 中京 |
| 03 | 福島 | 08 | 京都 |
| 04 | 新潟 | 09 | 阪神 |
| 05 | 東京 | 10 | 小倉 |

### レースID体系
```
YYYYVVKKDDNN
YYYY = 年, VV = 競馬場コード, KK = 開催(01-06), DD = 日次(01-12), NN = R番号(01-12)
```

### 使い方
```bash
node runner.js 2026 05              # 2026年東京 全開催
node runner.js 2026 05 1 1          # 2026年東京 第1回のみ
node runner.js 2026 05 1 1 4 4      # 2026年東京 第1回4日目のみ
```

---

## 3. build_base_times.js — 基準タイム生成

### 概要
全レース結果から**良馬場**のデータのみを抽出し、(競馬場, 距離, クラス)ごとの基準タイムを算出する。

### 入出力
- **入力**: `./race_result/*.csv`
- **出力**: `./base_times.json`

### フィルタ条件
- 芝レースのみ
- 良馬場のみ
- 障害レースは除外

### クラス分類
| レース条件 | カテゴリ | 基準指数 |
|------------|----------|----------|
| 新馬, 未勝利 | 未勝利 | 280 |
| 1勝, 500万下 | 1勝クラス | 300 |
| 2勝, 1000万下 | 2勝クラス | 305 |
| 3勝, 1600万下 | 3勝クラス | 310 |
| オープン, G1-G3, リステッド | OP | 315 |

### 算出値
各(競馬場, 距離, クラス)について:
- **基準走破秒** = 良馬場の全完走馬の走破タイム平均
- **基準前半秒** = 良馬場の全完走馬の前半タイム平均
- **基準上がり秒** = 良馬場の全完走馬の上がり3Fタイム平均
- **回帰スロープ** = (競馬場, 距離)単位の前半-上がり回帰係数

### 回帰スロープの計算
```
slope = Σ((前半_i - 前半平均) × (上がり_i - 上がり平均)) / Σ((前半_i - 前半平均)²)
```
前半が速いほど上がりが遅くなる関係をモデル化（最小二乗法）。

---

## 4. build_baba_diff.js — 馬場差算出

### 概要
全レース結果と基準タイムを比較し、**開催日ごとの馬場差**（コースの速さ/遅さ）を算出する。

### 入出力
- **入力**: `./race_result/*.csv`, `./base_times.json`
- **出力**: `./baba_diff.json`

### 処理
1. 各完走馬のタイム偏差を計算:
   ```
   rawDev = 実走破秒 - 基準走破秒
   normDev = rawDev × (2000 / 距離)   ← 2000m換算
   ```
2. 同じ日（年_競馬場_開催_日次）の偏差を平均:
   ```
   馬場差 = Σ(normDev) / n   （n ≥ 3頭が条件）
   ```
3. 絶対閾値で7段階分類（良馬場基準からの偏差なので、良馬場≈極速）:
   | 分類 | 馬場差(2000m換算秒) |
   |------|---------------------|
   | 極速 | < 0.5 |
   | 速 | 0.5 ~ 1.0 |
   | 稍速 | 1.0 ~ 1.5 |
   | 標準 | 1.5 ~ 2.0 |
   | 稍遅 | 2.0 ~ 3.0 |
   | 遅 | 3.0 ~ 5.0 |
   | 極遅 | ≥ 5.0 |

### 馬場差の解釈
- **負の値** = 速い馬場（基準より速いタイムが出やすい）
- **正の値** = 遅い馬場（基準より遅いタイムが出やすい）
- 単位は2000m換算の秒数

---

## 5. calc_index.js — 指数算出

### 概要
基準タイムと馬場差を用いて、各馬に**総合指数**・**上がり指数**・**能力指数**の3種類の指数を付与する。

### 入出力
- **入力**: `./race_result/*.csv`, `./base_times.json`, `./baba_diff.json`
- **出力**: `./race_index/index_{raceId}.csv`

### キャリブレーション
アンカーポイント: **イクイノックス 2023天皇賞秋 = 336**
```
OP良馬場基準: 119.32秒, 基準指数315
馬場差(当日): -0.86秒
補正後基準: 119.32 + (-0.86) = 118.46秒
実走破: 115.2秒, 差: 3.26秒 → 21ポイント
factor = 21 / 3.26 = 6.442
```

### 距離補正係数
```
factor(距離) = 6.442 × (2000 / 距離)
```
短距離ほど1秒の差が大きな指数差になる。

### 5.1 総合指数
走破タイムと斤量から算出する指数。斤量補正により同一レース内で着順との逆転が起こりうる。
```
馬場差(距離補正) = 馬場差(2000m換算) × (距離 / 2000)
補正基準タイム = 基準走破秒 + 馬場差(距離補正)

斤量補正 = (斤量 - 57) × 0.2 × (距離 / 2000)
  ※基準斤量57kg、1kgあたり0.2秒(2000m換算)、距離比例

タイム差 = 補正基準タイム - 実走破秒 + 斤量補正

総合指数 = round(基準指数※ + タイム差 × factor)

※世代補正適用後の基準指数
```

### 5.2 上がり指数
ペース（前半タイム）と脚溜め（ポジション）を考慮した末脚の質の評価。着順と逆転しうる。

**ステップ1: ペースから期待される上がりを算出**
```
馬場差は前半60%・上がり40%に配分:
  補正前半基準 = 基準前半秒 + 馬場差 × 0.6
  補正上がり基準 = 基準上がり秒 + 馬場差 × 0.4

前半差 = 実前半秒 - 補正前半基準
期待上がり = 補正上がり基準 + slope × 前半差
```

**ステップ2: 脚溜め補正**
後方待機で温存したエネルギー分を上がりに加算（ペナルティ）。
```
先頭前半 = レース内の最速前半タイム
ポジション差 = 実前半秒 - 先頭前半
脚溜めペナルティ = ポジション差 × 0.6
補正上がり = 実上がり秒 + 脚溜めペナルティ
```

**ステップ3: 上がり指数算出**
```
上がり指数 = round((期待上がり - 補正上がり) × factor)
```
- **正の値** = 期待より速い上がり（末脚の質が高い）
- **負の値** = 期待より遅い上がり

### 5.3 能力指数
総合指数と上がり指数を統合した総合評価。着順との逆転が起こりうる。
```
能力指数 = round(総合指数 + 上がり指数 × 0.5)
```

### 5.4 世代補正
世代限定レースは古馬混合レースより走力が低いため、基準指数を引き上げて指数を下げる。
```
OP:     3歳限定 +7, 2歳限定 +12
1勝クラス: 3歳限定 +2, 2歳限定 +3
```

### 使い方
```bash
node calc_index.js                    # 全レース処理
node calc_index.js 202305040911       # 特定レースのみ
```

---

## 6. build_viewer_data.js — ビューアデータ生成

### 概要
race_indexのCSVを年ごとのJSONに変換し、GitHub Pagesビューア用データを生成する。

### 入出力
- **入力**: `./race_index/index_*.csv`
- **出力**: `./docs/data_{year}.json`, `./docs/meta.json`

### データ形式
配列形式でキー名を省略し、ファイルサイズを削減。
```
Race: [raceId, year, venue, kaisai, day, class, surface, dist, weather, condition, horses[]]
Horse: [rank, gate, num, name, age, weight, jockey, time, margin, passing, last3f, pop, odds, totalIdx, last3fIdx, abilityIdx]
```

### 使い方
```bash
node build_viewer_data.js
```

---

## 7. scrape_baba.js — JRA馬場状態PDF取得

### 概要
JRA公式サイトの馬場状態PDFからクッション値・含水率を取得する。
分析の結果、クッション値/含水率は走破タイムとの相関が低く(R²=1.3%)、指数計算には使用していない。

### 入出力
- **入力**: `https://jra.jp/keiba/baba/archive/{year}pdf/{venue}{kai}.pdf`
- **出力**: `./baba_data.json`

### 使い方
```bash
node scrape_baba.js              # 2019-2025
node scrape_baba.js 2023 2024    # 年範囲指定
```

---

## 8. 指数の読み方

### 目安
| 指数帯 | レベル |
|--------|--------|
| 330+ | G1級 |
| 320-329 | 重賞級 |
| 310-319 | OP級 |
| 300-309 | 条件戦上位 |
| 280-299 | 条件戦〜未勝利 |

### 3種類の指数の違い
- **総合指数**: 純粋なタイム評価。着順と完全に一致。
- **上がり指数**: 末脚の質。正なら「ペース・位置取り以上に速い上がり」。
- **能力指数**: 総合評価。着順と逆転可能（「負けて強し」を検出）。

---

## 9. 依存パッケージ
| パッケージ | 用途 |
|------------|------|
| cheerio | HTMLパース（scraper.js） |
| pdfjs-dist@3.11.174 | PDFテキスト抽出（scrape_baba.js） |
| puppeteer | 未使用（初期に使用、cheerio+curlに移行済み） |

---

## 10. データ規模（2025年2月時点）
| 項目 | 件数 |
|------|------|
| レース結果CSV | 27,405件 |
| 指数算出済み（芝） | 13,061レース |
| 基準タイム | 284エントリ |
| 馬場差データ | 2,285日分 |
| 対象期間 | 2018-2026年 |
| 対象競馬場 | 全10場 |
